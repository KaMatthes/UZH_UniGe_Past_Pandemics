---
title: "Quantifying pandemic spread and public health interventions during three global pandemics in Switzerland 1889, 1918 and 2020"
author: "Katarina Matthes"
date: "`r Sys.Date()`"
output:
  rmdformats::robobook:
    code_folding: show
    self_contained: true
    highlight: pygments
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

# Research question

* Are patterns of pandemic spread, its determinants, and effects of public health interventions are similar across pandemics in Switzerland?
* Estimate excess mortality for pandemics in 1890, 1918 and 2020 per district, age groups and sex
* Comparing of spatial pattern between the pandemics
* Investigate the determinants of spread in the context of different co-factors ( Urbanization, GIP per capita etc.)


# Data

## Historical data

* Collected and digitalized from Kaspar Staub's team
* Pandemic 1890 (Russian flu): Data from 1879 - 1895
* Pandemic 1918 (Spanish flu): Data from 1908 - 1925
* Mortality data for each year, district, age group and sex
* Population data for census of 1880, 1888, 1900, 1910, 1920 for all districts
* Population data for sex and age group only  for year census 1888 and 1910 
* Years between were interpolated

Example death counts

```{r echo=FALSE, out.width = '100%'}
knitr::include_graphics("../data/Beispiel.png")
```

Example census data

```{r echo=FALSE, out.width = '100%'}
knitr::include_graphics("../data/Census.png")
```


Book scanner

```{r echo=FALSE, out.width = '100%'}
knitr::include_graphics("../data/Bookscanner.png")
```

## Covid 19

* Death and population data from 2014 - 2020 for each district, sex and age group

<!-- ## Age -->

<!-- * Age groups aggregated so that there are the same in all years  (for death and population data) -->
<!-- * 1879 - 1885 only larger age groups and not separated by sex -->
<!-- * But total by sex available -->

<!-- ```{r} -->
<!-- load(paste0("../data/data_total.RData"))  -->
<!-- dat.age <- data_total %>% -->
<!--   mutate(Year = as.character(Year), -->
<!--     Year = as.numeric(Year))%>% -->
<!--   arrange(Year) -->

<!-- dat.tab.age <- as.data.frame.matrix(table(data_total$Year, data_total$age_group)) %>% -->
<!--   mutate(Year = row.names(.)) %>% -->
<!--   mutate_if(is.integer, ~ if_else(.>0,"1", "0")) %>% -->
<!--   mutate(Year = as.numeric(Year)) %>% -->
<!--   arrange(Year) %>% -->
<!--   select(Year, `0_4`, `5_14`:`>60`, `0_19`:`60_69`, `>70`) -->

<!-- dat.tab.age %>% -->
<!--   kbl(row.names = F) %>% -->
<!--   kable_material(c("striped", "hover"),full_width = F,position = "left") -->
<!-- ``` -->

<!-- ## Population -->

<!-- * Modern data population for all districts and all age groups and sex available -->
<!-- * Census 1888 and 1910 population data for all districts and age groups and sex, but 1900 and 1920 are not collect ->  might a problem -->
<!-- * Census 1880, 1888, 1900, 1910, 1920  census data for all districts -->
<!-- <br /> -->
<!-- <br /> -->
<!-- Estimation: -->
<!-- * Interpolation for total and each districts (census 1880, 1888, 1900, 1910, 1920) -->
<!-- * Calculation of age distribution for 1888 and 1910 -->
<!-- * Take age distribution of 1888 to interpolate population between 1880 to 1900 and age distribution from 1910 to interpolate population between 1900 and 1920 -->
<!-- * Maybe a student from Kaspar will also collect detailed census data from 1900 and 1920, would be a bit more precise then -->

<!-- ## Maps -->

<!-- * All districts are harmonised so that 1890, 1918 and 2020 have the same districts. -->
<!-- * Many districts from 1879 - 1920 have been combined so that they are the same as 2014-2020. -->
<!-- * Schauffhausen is only one district, as death data is only available for Schaffhausen as a whole. -->
<!-- * In Solothurn, the districts are merged as in 1876 - 1920. -->
<!-- * New shapefiles created via QGIS to have one map for all years (to make them comparable). -->

# Methods
* Bayesian approach
* INLA (Bayesian inference for Latent Gaussian Models)
* Death data for $130$ districts of Switzerland for all three pandemics (1890, 1918, 2020)
* Data $Y$ is given as the total number of death in fixed areas and in each year
* Standard Poisson likelihood to model the counts $$ y_i \mid \eta_i\sim Po\left(E_i \exp(\eta_i)\right),$$
where $E_i$ is the ``population at risk'' in region $i$.
* Default: gamma prior distributions of INLA
where $\textrm{Gamma}(\alpha, \beta)$ denotes the gamma density
with shape parameter $\alpha$ and rate parameter $\beta$. The default
values are $\alpha_u = \alpha_v = 1$ and $\beta_u = \beta_v = 0.00005$.

* calculation of expected values based on the mortality trend of the previous 4 years (1890 only 4 years possible)

```{r, echo=TRUE,message=FALSE, eval=FALSE}
 formula =
    death ~ 1 + offset(log(population)) +
    f(Region.struct, model="besag", graph="Bezirk_Inla", scale.model = TRUE)
    f(Year, model='iid', constr = TRUE) +
    f(Region, model='iid', constr = TRUE) +


inla.mod = inla(formula,
                  data=reg_data,
                  family="Poisson",
                  verbose = TRUE,
                  control.compute=list(config = TRUE),
                  control.mode=list(restart=T),
                  num.threads = round(parallel::detectCores()*.8),
                  control.predictor=list(compute=T))
```


* 1000 samples from the posterior distribution
* Calculation of median and 95% CrI(Credible interval) of the 1000 samples
* Excess mortality = observed death counts – expected death counts

<!-- * Excess mortality is shown relatively in percentage (Excess mortality/expected death counts) -->
<!-- * To compare the districts of each pandemic year the relative excess mortality was normalized -->
<!-- * To find pattern and clusters: Moran’s I statistics ( LISA: Local Indicators of Spatial Association) were used for mapping statistically significant local clusters -->

# Results

## Total

### Relative yearly numbers of excess deaths
```{r, echo=FALSE,message=FALSE,fig.height = 30,  fig.width = 10}
function_year()
```

### Maps
Significant means that the observed value is outside the CrI.

```{r, echo=FALSE,message=FALSE,fig.height = 12,  fig.width = 10}
function_maps_inla("excess_rate_group")
```

```{r, echo=FALSE,message=FALSE,fig.height = 12,  fig.width = 10}
function_maps_inla("excess_per_quant2")
```

<!-- ### LISA (Local Indicators of Spatial Association) -->
<!-- ```{r, echo=FALSE,message=FALSE,fig.height = 12,  fig.width = 10} -->
<!-- cowplot::plot_grid(function_lisa(1890),function_lisa(1918),function_lisa(2020), -->
<!--                    nrow =2 ,ncol = 2) -->
<!-- ``` -->

## Sex

<!-- ### Women -Relative yearly numbers of excess deaths -->
<!-- ```{r, echo=FALSE,message=FALSE,fig.height = 30,  fig.width = 10} -->
<!-- function_year_sex(Sex="f") -->
<!-- ``` -->

<!-- ### Men -Relative yearly numbers of excess deaths -->
<!-- ```{r, echo=FALSE,message=FALSE,fig.height = 30,  fig.width = 10} -->
<!-- function_year_sex(Sex="m") -->
<!-- ``` -->

### Maps

<!-- ```{r, echo=FALSE,message=FALSE,fig.height = 12,  fig.width = 10} -->
<!-- function_maps_sex_inla("excess_rate_group") -->
<!-- ``` -->



```{r, echo=FALSE,message=FALSE,fig.height = 12,  fig.width = 10}
function_maps_sex_inla("excess_per_year_quant2")
```

<!-- ### LISA (Local Indicators of Spatial Association) -->
<!-- ```{r, echo=FALSE,message=FALSE,fig.height = 12,  fig.width = 10} -->
<!-- cowplot::plot_grid(function_lisa_sex(1890, "f"),function_lisa_sex(1890, "m"), -->
<!--                    function_lisa_sex(1918, "f"),function_lisa_sex(1918, "m"), -->
<!--                    function_lisa_sex(2020, "f"),function_lisa_sex(2020, "m"), -->
<!--                    nrow =3 ,ncol = 2) -->
<!-- ``` -->

## Age

<!-- ### 0-19 - Relative yearly numbers of excess deaths -->
<!-- ```{r, echo=FALSE,message=FALSE,fig.height = 30,  fig.width = 10} -->
<!-- function_year_age(Age="0_19") -->
<!-- ``` -->

<!-- ### 20-49 - Relative yearly numbers of excess deaths -->
<!-- ```{r, echo=FALSE,message=FALSE,fig.height = 30,  fig.width = 10} -->
<!-- function_year_age(Age="20_49") -->
<!-- ``` -->

<!-- ### 50-69 - Relative yearly numbers of excess deaths -->
<!-- ```{r, echo=FALSE,message=FALSE,fig.height = 30,  fig.width = 10} -->
<!-- function_year_age(Age="50_69") -->
<!-- ``` -->

<!-- ### >=70 - Relative yearly numbers of excess deaths -->
<!-- ```{r, echo=FALSE,message=FALSE,fig.height = 30,  fig.width = 10} -->
<!-- function_year_age(Age=">70") -->
<!-- ``` -->

### Maps


<!-- ```{r, echo=FALSE,message=FALSE,fig.height = 12,  fig.width = 10} -->
<!-- function_maps_age2_inla("excess_rate_group") -->
<!-- ``` -->



```{r, echo=FALSE,message=FALSE,fig.height = 12,  fig.width = 10}
function_maps_age2_inla("excess_per_year_quant2")
```

<!-- ### LISA (Local Indicators of Spatial Association) -->
<!-- ```{r, echo=FALSE,message=FALSE,fig.height = 12,  fig.width = 10} -->
<!-- cowplot::plot_grid(function_lisa_age(1890, "0_69"),function_lisa_age(1890, ">70"), -->
<!--                    function_lisa_age(1918, "0_69"),function_lisa_age(1918, ">70"), -->
<!--                    function_lisa_age(2020, "0_69"),function_lisa_age(2020, ">70"), -->
<!--                    nrow =3 ,ncol = 2) -->
<!-- ``` -->


<!-- ## Sex and Age -->
<!-- * Interpretation with caution -->

<!-- ### Maps -->
<!-- Age 0 - 69 year -->

<!-- ```{r, echo=FALSE,message=FALSE,fig.height = 12,  fig.width = 10} -->
<!-- function_maps_age2_sex(var="excess_perc_year_quant2",Age="0_69") -->
<!-- ``` -->

<!-- Age >=70 year -->

<!-- ```{r, echo=FALSE,message=FALSE,fig.height = 12,  fig.width = 10} -->
<!-- function_maps_age2_sex(var="excess_perc_year_quant2", Age=">70") -->
<!-- ``` -->

<!-- ### LISA (Local Indicators of Spatial Association) -->
<!-- Age 0 - 69 year -->
<!-- ```{r, echo=FALSE,message=FALSE,fig.height = 12,  fig.width = 10} -->
<!-- cowplot::plot_grid( -->
<!--                    function_lisa_age_sex(VarYear=1890, Age="0_69", Sex="f"),function_lisa_age_sex(VarYear=1890, Age="0_69", Sex="m"), -->
<!--                    function_lisa_age_sex(VarYear=1918, Age="0_69", Sex="f"),function_lisa_age_sex(VarYear=1918, Age="0_69", Sex="m"), -->
<!--                    function_lisa_age_sex(VarYear=2020, Age="0_69", Sex="f"),function_lisa_age_sex(VarYear=2020, Age="0_69", Sex="m"), -->
<!--                    nrow =3 ,ncol = 2) -->
<!-- ``` -->

<!-- Age >=70 year -->
<!-- ```{r, echo=FALSE,message=FALSE,fig.height = 12,  fig.width = 10} -->
<!-- cowplot::plot_grid( -->
<!--                    function_lisa_age_sex(VarYear=1890, Age=">70", Sex="f"),function_lisa_age_sex(VarYear=1890, Age=">70", Sex="m"), -->
<!--                    function_lisa_age_sex(VarYear=1918, Age=">70", Sex="f"),function_lisa_age_sex(VarYear=1918, Age=">70", Sex="m"), -->
<!--                    function_lisa_age_sex(VarYear=2020, Age=">70", Sex="f"),function_lisa_age_sex(VarYear=2020, Age=">70", Sex="m"), -->
<!--                    nrow =3 ,ncol = 2) -->
<!-- ``` -->

# Next steps, points to be discussed

1. Model choices? Now Besag.
2. Define priors, now only default (gamma). But maybe okay?
3. Add further Co-factors such as:
 * Urbanization
 * Infant mortality rates as a proxy for health index
 * Public health intervention for each district (canton)
 * GDP per capita as proxy for SES
 * Population density (population/km2)
 * Proportion of children, 5–15 y (as school-age children are thought to drive influenza transmission)





