---
title: "Quantifying pandemic spread and public health interventions during three global pandemics in Switzerland 1889, 1918 and 2020"
author: "Katarina Matthes"
date: "`r Sys.Date()`"
output:
  rmdformats::robobook:
    code_folding: show
    self_contained: true
    highlight: pygments
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

# Research question

* Are patterns of pandemic spread, its determinants, and effects of public health interventions are similar across pandemics in Switzerland?
* Estimate excess mortality for pandemics in 1890, 1918 and 2020 per district, age groups and sex
* Comparing of spatial pattern between the pandemics
* Investigate the determinants of spread in the context of different co-factors ( Urbanization, GIP per capita etc.)


# Data

## Historical data

* Collected and digitalized from Kaspar Staub's team
* Pandemic 1890: Data from 1879 - 1895
* Pandemic 1918: Data from 1908 - 1925
* Mortality data for each year, district, age group and sex
* Population data for census of 1880, 1888, 1900, 1910, 1920 for all districts
* Population data for sex and age group only  for year census 1888 and 1910
* The years in between were interpolated by district, sex and age

## Covid 19

* Death and population data from 2014 - 2020 for each district, sex and age group

## Maps

* All districts are harmonised so that 1890, 1918 and 2020 have the same districts.
* Many districts from 1879 - 1920 have been combined so that they are the same as 2014-2020.
* Schauffhausen is only one district, as death data is only available for Schaffhausen as a whole.
* In Solothurn, the districts are merged as in 1876 - 1920.
* New shapefiles created via QGIS to have one map for all years (to make them comparable

# Methods

## Excess Mortality

* Bayesian approach
* INLA (Bayesian inference for Latent Gaussian Models)
* Death data for 130 districts of Switzerland for all three pandemics (1890, 1918, 2020)
* Data is given as the total number of death in fixed areas and in each year
* Because of high number of zero and to avoid overdispersio - Zero inflated negative binomial to model the counts
* classical disease mapping model; BYM model (Besag, York and Mollie proposed it)

<!-- * The log relative risk, $\bf{\eta} = (\eta_1, \dots, \eta_n)^T$, is thus decomposed -->
<!--   into $$\bf{\eta} = \mu + \bf{u} + \bf{v} $$ -->
<!--   +  $\mu$ is the overall intercept -->
<!--   +  $\bf{u}$ is a random effect with spatial structure following the Besag model -->
<!--   +  $\bf{v}$ represents a non-spatial overdispersion -->
<!-- * ${\bf u}$ is "besag" modelled spatially structured with smoothing parameter $\kappa_u$. -->
<!-- * ${\bf v}$ is unstructured with precision parameter $\kappa_v$, i.e. -->
<!-- $\bf{v} \sim \mathcal{N}(0, \kappa_v^{-1}I)$. -->
<!-- * The precision terms $\kappa_v$ and $\kappa_u$ are assigned the default -->
<!-- gamma prior distributions of INLA -->
<!-- $$ -->
<!-- \begin{aligned} -->
<!--   \kappa_u & \sim \textrm{Gamma}( \alpha_u, \beta_u ), \\ -->
<!--   \kappa_v & \sim \textrm{Gamma}( \alpha_v, \beta_v ). -->
<!-- \end{aligned} -->
<!-- $$ -->
<!-- * The default values are $\alpha_u = \alpha_v = 1$ and $\beta_u = \beta_v = 0.00005$. -->
<!-- <br /> -->
<!-- <br /> -->

* Year is modelled using an independent and identically (iid)  Gaussian prior distribution

<!-- with ${N}(0,  \tau_v^{-1})$ -->
<br />
* Calculation of expected values based on the mortality trend of the previous 4 years (1890 only 4 years possible)

```{r, echo=TRUE,message=FALSE, eval=FALSE}
 formula <- death ~ 1 + offset(log(population)) +
    f(Year, model='iid', constr = TRUE) +
    f(Region, model="bym", graph="Bezirk_Inla", scale.model = TRUE)

inla.mod = inla(formula,
                  data=reg_data,
                  family = "zeroinflatednbinomial0",
                  verbose = TRUE,
                  control.compute=list(config = TRUE),
                  control.mode=list(restart=T),
                  num.threads = round(parallel::detectCores()*.8),
                  control.predictor=list(compute=T))
```

<br />
<br />

* 1000 samples from the posterior distribution were sampled
* Calculation of median and 95% CrI(Credible interval) of the 1000 samples
* Excess mortality = observed death counts â€“ expected death counts

##  Hotspots
* Gi statistics
* Represents as a Z-score
* Greater values represent a greater intensity of clustering and the direction (positive or negative) indicates high or low clusters.


##  Co-factors


# Results

## Maps

### Year

```{r, echo=FALSE,message=FALSE,fig.height = 10,  fig.width = 12}
function_maps_inla()
```

```{r, echo=FALSE,message=FALSE,fig.height = 8,  fig.width = 12}
function_hotspot(Year_Pan=1890)
function_hotspot(Year_Pan=1918)
function_hotspot(Year_Pan=2020)
```


### Sex
In the pandemic 1890 no significant difference between sex was observed. In the pandemic 1918 and 2020 higher excess mortality in men compared to women was shown.

<br />
<br />

1890

```{r, echo=FALSE,message=FALSE,fig.height = 8,  fig.width = 12}
function_maps_sex(Year_Pan=1890)
function_regression_mortality(VarTest = "Sex")[1]
```

<br />
<br />

1918

```{r, echo=FALSE,message=FALSE,fig.height = 8,  fig.width = 12}
function_maps_sex(Year_Pan=1918)
function_regression_mortality(VarTest = "Sex")[2]
```

<br />
<br />

2020

```{r, echo=FALSE,message=FALSE,fig.height = 8,  fig.width = 12}
function_maps_sex(Year_Pan=2020)
function_regression_mortality(VarTest = "Sex")[3]
```

### Age

Since the highest excess death in the 1918 pandemic was between 20 - 39 years, we further divided the age groups from 0-69 years into 3 additional groups for the 1918 pandemic. In the other pandemics, this is not possible due to low death rates in the younger age groups.
<br />
<br />
In 1890 no significant differences in excess mortality between age age groups.  1918 higher excess mortality for age group 0-69 years compared to > 70 years, in 2020 lower excess mortality for age group 0-69 years compared to < 70 years.
<br />
<br />

1890
```{r, echo=FALSE,message=FALSE,fig.height = 8,  fig.width = 12}
function_maps_age(Year_Pan=1890)
function_regression_mortality(VarTest = "Age")[1]
```
<br />
<br />

1918
```{r, echo=FALSE,message=FALSE,fig.height = 8,  fig.width = 12}
function_maps_age(Year_Pan=1918)
function_regression_mortality(VarTest = "Age")[2]
```
<br />
<br />

2020
```{r, echo=FALSE,message=FALSE,fig.height = 8,  fig.width = 12}
function_maps_age(Year_Pan=2020)
function_regression_mortality(VarTest = "Age")[3]
```

1918
Age groups 0-19, 20-39 and 40-69 show higher excess mortality compared to >70 years. The  highest excess mortality shows the age group 20-39.

```{r, echo=FALSE,message=FALSE,fig.height = 12,  fig.width = 12}
function_maps_age_1918()
function_regression_mortality(VarTest = "Age_1918")
```


### Age and Sex 1918

1918 - Age 20 - 39
<br />
<br />
The relative mortality rate is above 14% for both sexes in the 20-39 age group, but even higher for men than for women.

```{r, echo=FALSE,message=FALSE,fig.height = 8,  fig.width = 12}
function_maps_sex_age_1918()
function_regression_mortality(VarTest = "Age_Sex_1918")
```


## Co-factors

### Relation between 1890 and 1918

```{r, echo=FALSE,message=FALSE,fig.height = 10,  fig.width = 12}
function_cor_pandemic()
```


<!-- ```{r, echo=FALSE,message=FALSE} -->
<!-- function_test_pandemic() -->
<!-- ``` -->


The higher the excess mortality in 1890 the lower the excess mortality in 1918 (but not significant, but clearly a negative trend)

```{r, echo=FALSE,message=FALSE,fig.height = 10,  fig.width = 12}
function_cor_pandemic_age()
```


<!-- ```{r, echo=FALSE,message=FALSE} -->
<!-- function_test_pandemic_age() -->
<!-- ``` -->


<!-- ```{r, echo=FALSE,message=FALSE,warning=FALSE} -->
<!-- function_maps_age_1890_1918() -->
<!-- ``` -->


### Regression Analysis
 
1890

```{r, echo=FALSE,message=FALSE,warning=FALSE}
function_regression(1890)
```

1918

```{r, echo=FALSE,message=FALSE,warning=FALSE}
function_regression(1918)
```
2020

```{r, echo=FALSE,message=FALSE,warning=FALSE}
function_regression(2020)
```

<!-- ```{r, echo=FALSE,message=FALSE}function_maps_1890_1818()
 ```

<!-- The higher the proportion of people aged >=30, the lower the excess mortality (but not significant, but clearly a negative trend) -->

<!-- ```{r, echo=FALSE,message=FALSE} -->
<!-- function_maps_age_1818() -->
<!-- ``` -->

### GDP per capita
GDP per capita was taken from 1888 for 1890, 1910 for 1918, 2008 for 2020.

```{r, echo=FALSE,message=FALSE,fig.height = 10,  fig.width = 12}
function_cor_gdp()
```

GDP per capita is not significantly associated with excess mortality.
<br />
<br />

<!-- 1890 -->

<!-- ```{r, echo=FALSE,message=FALSE} -->
<!-- function_test_gdp(Year_Pan=1890) -->
<!-- ``` -->

<!-- 1918 -->

<!-- ```{r, echo=FALSE,message=FALSE} -->
<!-- function_test_gdp(Year_Pan=1918) -->
<!-- ``` -->

<!-- 2020 -->

<!-- ```{r, echo=FALSE,message=FALSE} -->
<!-- function_test_gdp(Year_Pan=2020) -->
<!-- ``` -->

### Swiss SEP per capita
Only for 2020, Swiss SEP from xxx (from which year?)

```{r, echo=FALSE,message=FALSE,fig.height = 10,  fig.width = 12}
function_cor_sep()
```

Swiss SEP is significantly associated with excess mortality. The higher the SEP is the excess mortality.

<!-- ```{r, echo=FALSE,message=FALSE} -->
<!-- function_test_sep() -->
<!-- ``` -->

<!-- ```{r, echo=FALSE,message=FALSE} -->
<!-- function_maps_sep() -->
<!-- ``` -->

### Number of hospitals

```{r, echo=FALSE,message=FALSE,warning=FALSE,fig.height = 10,  fig.width = 12}
function_cor_hospitals()
```

The number of hospitals per 10'000 inhabitants is not significantly associated with excess mortality. But perhaps distance to hospital would be a better explanatory variable than number of hospitals.

<!-- 1890 -->

<!-- ```{r, echo=FALSE,message=FALSE,warning=FALSE} -->
<!-- function_test_hospitals(Year_Pan=1890) -->
<!-- ``` -->

<!-- 1918 -->

<!-- ```{r, echo=FALSE,message=FALSE, warning=FALSE} -->
<!-- function_test_hospitals(Year_Pan=1918) -->
<!-- ``` -->


### Proportion of children aged 5-14

```{r, echo=FALSE,message=FALSE,fig.height = 10,  fig.width = 12}
function_cor_schoolkids()
```


Proportion of children aged 5-14 years is not significantly associated with excess mortality.

<!-- 1890 -->

<!-- ```{r, echo=FALSE,message=FALSE} -->
<!-- function_test_schoolkids(Year_Pan=1890) -->
<!-- ``` -->

<!-- 1918 -->

<!-- ```{r, echo=FALSE,message=FALSE} -->
<!-- function_test_schoolkids(Year_Pan=1918) -->
<!-- ``` -->

<!-- 2020 -->

<!-- ```{r, echo=FALSE,message=FALSE} -->
<!-- function_test_schoolkids(Year_Pan=2020) -->
<!-- ``` -->

### Proportion of child mortality
Child mortality was taken from the year before the pandamic

```{r, echo=FALSE,message=FALSE,fig.height = 10,  fig.width = 12}
function_cor_child_mort()
```


Child mortality is not significantly associated with excess mortality.

<!-- 1890 -->

<!-- ```{r, echo=FALSE,message=FALSE} -->
<!-- function_test_child_mort(Year_Pan=1890) -->
<!-- ``` -->

<!-- 1918 -->

<!-- ```{r, echo=FALSE,message=FALSE} -->
<!-- function_test_child_mort(Year_Pan=1918) -->
<!-- ``` -->

### Tuberculosis

1890: tb death cases from 1886-1890
1918: tb death cases from 1911-1920

Unfortunately, there is no exact number for the years 1890 and 1918.

In Davos was a high tuberculosis mortality because Davos was a health resort for tuberculosis patients in the 19th century and at the beginning of the 20th century.

<!-- Since these mortality numbers do not reflect the population and actual tuberculosis mortalities in Davos, Davos was excluded of the calculation -->
<br />
<br />

<!-- 1890 -->

```{r, echo=FALSE,message=FALSE,warning=FALSE}
function_cor_tbc()
```

<!-- Tuberculosis mortality is significantly associated with excess mortality in 1890 -->

<!-- ```{r, echo=FALSE,message=FALSE,warning=FALSE} -->
<!-- function_test_tbc(Year_Pan=1890) -->
<!-- ``` -->

<!-- <br /> -->
<!-- <br /> -->

<!-- 1918 -->


<!-- ```{r, echo=FALSE,message=FALSE,warning=FALSE} -->
<!-- function_maps_tbc(Year_Pan=1918) -->
<!-- ``` -->

<!-- Tuberculosis mortality is significantly associated with excess mortality in 1890 -->

<!-- ```{r, echo=FALSE,message=FALSE,warning=FALSE,fig.height = 10,  fig.width = 12} -->
<!-- function_test_tbc(Year_Pan=1918) -->
<!-- ``` -->

### Population density

```{r, echo=FALSE,message=FALSE,warning=FALSE,fig.height = 10,  fig.width = 12}
function_cor_area()
```

Regression analysis with all districts. Population density is not significantly associated with excess mortality. However, excess mortality is lower in all 3 pandemics the higher the population density. The reason for this could perhaps be the better medical care in larger cities? The greater proximity to the hospitals or medical office?

<!-- 1890 -->

<!-- ```{r, echo=FALSE,message=FALSE} -->
<!-- function_test_area(Year_Pan=1890) -->
<!-- ``` -->

<!-- 1918 -->

<!-- ```{r, echo=FALSE,message=FALSE} -->
<!-- function_test_area(Year_Pan=1918) -->
<!-- ``` -->

<!-- 2020 -->

<!-- ```{r, echo=FALSE,message=FALSE} -->
<!-- function_test_area(Year_Pan=2020) -->
<!-- ``` -->


### Urbanity

```{r, echo=FALSE,message=FALSE,warning=FALSE,fig.height = 10,  fig.width = 12}
function_cor_urbanity()
```

<!-- Ubanity is not significantly associated with excess mortality. However, the median excess mortality is lower in urban areas in all 3 pandemics. -->

<!-- 1890 -->

<!-- ```{r, echo=FALSE,message=FALSE} -->
<!-- function_test_urbanity(Year_Pan=1890) -->
<!-- ``` -->

<!-- 1918 -->

<!-- ```{r, echo=FALSE,message=FALSE} -->
<!-- function_test_urbanity(Year_Pan=1918) -->
<!-- ``` -->

<!-- 2020 -->

<!-- ```{r, echo=FALSE,message=FALSE} -->
<!-- function_test_urbanity(Year_Pan=2020) -->
<!-- ``` -->

### Train stations

```{r, echo=FALSE,message=FALSE,warning=FALSE,fig.height = 10,  fig.width = 12}
function_cor_stations()
```

<!-- The number of train stations in the respective districts is not significantly associated with excess mortality. -->

<!-- 1890 -->

<!-- ```{r, echo=FALSE,message=FALSE} -->
<!-- function_test_stations(Year_Pan=1890) -->
<!-- ``` -->

<!-- 1918 -->

<!-- ```{r, echo=FALSE,message=FALSE} -->
<!-- function_test_stations(Year_Pan=1918) -->
<!-- ``` -->

### Kfo index

```{r, echo=FALSE,message=FALSE,warning=FALSE,fig.height = 10,  fig.width = 12}
function_cor_kfo()
```
