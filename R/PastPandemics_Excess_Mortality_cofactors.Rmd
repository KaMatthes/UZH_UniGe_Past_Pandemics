---
title: "Quantifying pandemic spread and public health interventions during three global pandemics in Switzerland 1889, 1918 and 2020"
author: "Katarina Matthes"
date: "`r Sys.Date()`"
output:
  rmdformats::robobook:
    code_folding: show
    self_contained: true
    highlight: pygments
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

# Research question

* Are patterns of pandemic spread, its determinants, and effects of public health interventions are similar across pandemics in Switzerland?
* Estimate excess mortality for pandemics in 1890, 1918 and 2020 per district, age groups and sex
* Comparing of spatial pattern between the pandemics
* Investigate the determinants of spread in the context of different co-factors ( Urbanization, GIP per capita etc.)


# Data

## Historical data

* Collected and digitalized from Kaspar Staub's team
* Pandemic 1890 (Russian flu): Data from 1879 - 1895
* Pandemic 1918 (Spanish flu): Data from 1908 - 1925
* Mortality data for each year, district, age group and sex
* Population data for census of 1880, 1888, 1900, 1910, 1920 for all districts
* Population data for sex and age group only  for year census 1888 and 1910 
* Years between were interpolated

## Covid 19

* Death and population data from 2014 - 2020 for each district, sex and age group

# Methods
* Bayesian approach
* INLA (Bayesian inference for Latent Gaussian Models)
* Death data for $130$ districts of Switzerland for all three pandemics (1890, 1918, 2020)
* Data $Y$ is given as the total number of death in fixed areas and in each year
* Standard Poisson likelihood to model the counts $$ y_i \mid \eta_i\sim Po\left(E_i \exp(\eta_i)\right),$$
where $E_i$ is the ``population at risk'' in region $i$.
<br />
<br />
* classical disease mapping model; BYM model (Besag, York and Mollie proposed it)
* The log relative risk, $\bf{\eta} = (\eta_1, \dots, \eta_n)^T$, is thus decomposed
  into $$\bf{\eta} = \mu + \bf{u} + \bf{v} $$
  +  $\mu$ is the overall intercept
  +  $\bf{u}$ is a random effect with spatial structure following the Besag model 
  +  $\bf{v}$ represents a non-spatial overdispersion
* ${\bf u}$ is "besag" modelled spatially structured with smoothing parameter $\kappa_u$. 
* ${\bf v}$ is unstructured with precision parameter $\kappa_v$, i.e.
$\bf{v} \sim \mathcal{N}(0, \kappa_v^{-1}I)$.
* The precision terms $\kappa_v$ and $\kappa_u$ are assigned the default
gamma prior distributions of INLA
$$
\begin{aligned}
  \kappa_u & \sim \textrm{Gamma}( \alpha_u, \beta_u ), \\
  \kappa_v & \sim \textrm{Gamma}( \alpha_v, \beta_v ).
\end{aligned}
$$
* The default values are $\alpha_u = \alpha_v = 1$ and $\beta_u = \beta_v = 0.00005$.
<br />
<br />

* Year is modelled using independent and identically (iid)  Gaussian prior distribution
with ${N}(0,  \tau_v^{-1})$
<br />
* Calculation of expected values based on the mortality trend of the previous 4 years (1890 only 4 years possible)

```{r, echo=TRUE,message=FALSE, eval=FALSE}
 formula =
    death ~ 1 + offset(log(population)) +
    f(Region, model="bmy", graph="Bezirk_Inla", scale.model = TRUE)+
    f(Year, model='iid', constr = TRUE) 
   
inla.mod = inla(formula,
                  data=reg_data,
                  family="Poisson",
                  verbose = TRUE,
                  control.compute=list(config = TRUE),
                  control.mode=list(restart=T),
                  num.threads = round(parallel::detectCores()*.8),
                  control.predictor=list(compute=T))
```

<br />
<br />

* 1000 samples from the posterior distribution
* Calculation of median and 95% CrI(Credible interval) of the 1000 samples
* Excess mortality = observed death counts – expected death counts

<!-- <!-- * Excess mortality is shown relatively in percentage (Excess mortality/expected death counts) -->
<!-- <!-- * To compare the districts of each pandemic year the relative excess mortality was normalized -->
<!-- <!-- * To find pattern and clusters: Moran’s I statistics ( LISA: Local Indicators of Spatial Association) were used for mapping statistically significant local clusters --> 

# Results

## Maps

### Year

```{r, echo=FALSE,message=FALSE,fig.height = 8,  fig.width = 10}
function_maps_inla()
```

### Sex
Because excess death is different in each pandemic year, and to better compare sex per pandemic year, the divisions of relative excess death per year are different.

```{r, echo=FALSE,message=FALSE,fig.height = 5,  fig.width = 12}
function_maps_sex(Year_Pan=1890)
function_maps_sex(Year_Pan=1918)
function_maps_sex(Year_Pan=2020)
```

### Age

Because excess death is different in each pandemic year, and to better compare age groups per pandemic year, the divisions of relative excess death per year are different. Since the highest excess death in the 1918 pandemic was between 20 - 39 years, we further divided the age groups from 0-69 years into 3 additional groups for the 1918 pandemic. In the other pandemic years, this is not possible due to low death rates in the younger age groups.

```{r, echo=FALSE,message=FALSE,fig.height = 5,  fig.width = 12}
function_maps_age(Year_Pan=1890)
function_maps_age(Year_Pan=1918)
function_maps_age(Year_Pan=2020)
```

1918

```{r, echo=FALSE,message=FALSE,fig.height = 10,  fig.width = 12}
function_maps_age_1918()
```


### Age and Sex

Because excess death is different in each pandemic year, and to better compare age groups per pandemic year, the divisions of relative excess death per year are different. Since the highest excess death in the 1918 pandemic was between 20 - 39 years, we further divided the age groups from 0-69 years into 3 additional groups for the 1918 pandemic. In the other pandemic years, this is not possible due to low death rates in the younger age groups.

```{r, echo=FALSE,message=FALSE,fig.height = 5,  fig.width = 12}
function_maps_sex_age(Year_Pan=1890, Age="0_69")
function_maps_sex_age(Year_Pan=1890, Age=">70")
function_maps_sex_age(Year_Pan=1918, Age="0_69")
function_maps_sex_age(Year_Pan=1918, Age=">70")
function_maps_sex_age(Year_Pan=2020, Age="0_69")
function_maps_sex_age(Year_Pan=2020, Age=">70")
```

1918 - Age 20 - 39
<br />
<br />
Relative excess death is greater than 14% in both sexes in the age group 20-39 years, but it is even higher in men than in women.

```{r, echo=FALSE,message=FALSE,fig.height = 5,  fig.width = 12}
function_maps_sex_age_1918()
```
