---
title: "Past Pandemics"
author: "Katarina Matthes"
date: "`r Sys.Date()`"
output:
  rmdformats::robobook:
    code_folding: show
    self_contained: true
    highlight: pygments
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

# Research question

* Estimate excess mortality for pandemics in 1890, 1918 and 2020 per district, age groups and sex
* Comparing of spatial pattern between the pandemics
* Investigate the determinants of spread in the context of different co-factors ( Urbanization, GIP per capita, etc-)

# Data

* Collected and digitalized from Kaspar Staub's team
* Russian flu: 1879 - 1895
* Spanish fl:  1908 - 1925
* Covid19 : 2020


## Age

* Age groups aggregated so that there are the same in all years  (for death and population data)
* 1879 - 1885 only larger age groups and not separated by sex
* But total by sex available

```{r}
load(paste0("../data/data_total.RData")) 
dat.age <- data_total %>%
  mutate(Year = as.character(Year),
    Year = as.numeric(Year))%>%
  arrange(Year)

dat.tab.age <- as.data.frame.matrix(table(data_total$Year, data_total$age_group)) %>%
  mutate(Year = row.names(.)) %>%
  mutate_if(is.integer, ~ if_else(.>0,"1", "0")) %>%
  mutate(Year = as.numeric(Year)) %>%
  arrange(Year) %>%
  select(Year, `0_4`, `5_14`:`>60`, `0_19`:`60_69`, `>70`)

dat.tab.age %>%
  kbl(row.names = F) %>%
  kable_material(c("striped", "hover"),full_width = F,position = "left")
```

## Population

* Modern data population for all districts and all age groups and sex available
* Census 1888 and 1910 population data for all districts and age groups and sex, but 1900 and 1920 are not collect ->  might a problem
* Census 1888, 1900, 1910, 1920  census data for all districts
<br />
<br />
Estimation:
* Interpolation for total and each districts (census 1888, 1900, 1910, 1920)
* Take this slope for each district (from interpolation) and age distribution from 1888 to interpolate data until 1909. Take slope from 1910 to 1920 and age distribution from 1910 to interpolate to 1920
* Maybe a student from Kaspar will also collect detailed census data from 1900 and 1920, would be a bit more precise then

## Maps

* All districts are harmonised so that 1890, 1918 and 2020 have the same districts.
* Many districts from 1879 - 1920 have been combined so that they are the same as 2014-2020.
* Schauffhausen is only one district, as death data is only available for Schaffhausen as a whole.
* In Solothurn, the districts are merged as in 1876 - 1920.
* New shapefiles created via QGIS to have one map for all years (to make them comparable).

# Preliminary Methods
* Only all data (no age groups, no sex)
* Estimation of expected mortality using Poisson GLM
* Only yearly data available, therefor no seasonal effects etc can be taken into account
* Excess mortality is based on the trend in the previous 5 years
* Pandemic years 1890, 1918 and 2020 are excluded to estimate expected values 
* Bootstrapping to address the uncertainty in observed death counts and to provide a prediction interval (PI) for the predicted mortality(resampled N = 1000) 
* Excess mortality is given shown relatively in percentage (excess mortality = (pandemic year -baseline mortality)/baseline mortality
* Yearly numbers of excess deaths 
* One maps shows for 5 groups (0-20%, 20%-40%, 60%-80%, 80%-100%) to see difference between the pandemics
* To compare the districts the percentages are normalised, meaning for each year the quantiles are estimated, to see for example if same district have high excess mortaly between the pandemics
* To find pattern and clusters: Moran’s I statistics ( LISA: Local Indicators of Spatial Association) were user mapping statistically significant local clusters.


# Preliminary Results

## Relative yearly numbers of excess deaths
```{r, echo=FALSE,message=FALSE,fig.height = 30,  fig.width = 10}
function_year()
```

## Maps

```{r, echo=FALSE,message=FALSE,fig.height = 12,  fig.width = 10}
function_maps("excess_perc_groups")
```

```{r, echo=FALSE,message=FALSE,fig.height = 12,  fig.width = 10}
function_maps("excess_per_quant2")
```

## LISA (Local Indicators of Spatial Association)

```{r, echo=FALSE,message=FALSE,fig.height = 12,  fig.width = 10}
cowplot::plot_grid(function_lisa(1889),function_lisa(1890),function_lisa(1918),function_lisa(1919),function_lisa(2020),
                   nrow =3 ,ncol = 2)
```

# Next steps
1. Estimate population for age groups and sex
2. Estimate excess mortality for age groups and sex
  * Which methods? Sample size will be small and often zero, especially for younger age. 
  * Bayesian approaches in hierarchical modelling (INLA) to investigate the spatial pattern of excess mortality per district
  * Which years included? Age groups by sex only available since 1886. So maybe estimation of baseline mortality for the last 4 years?      * Sensitivity Analyses for 1918 and 2020 between 4 years and 5 years baseline mortality
3. Further Co-factors (I have to discuss with Kaspar):
 * Urbanization
 * Infant mortality rates as a proxy for health index
 * Public health intervention for each district (canton)
 * GDP per capita as proxy for SES
 * Population density (population/km2)
 * Proportion of children, 5–15 y (as school-age children are thought to drive influenza transmission)
 





