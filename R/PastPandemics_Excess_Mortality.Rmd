---
title: "Past Pandemics"
author: "Katarina Matthes"
date: "`r Sys.Date()`"
output:
  rmdformats::robobook:
    code_folding: show
    self_contained: true
    highlight: pygments
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

# Research question

* Estimate excess mortality for pandemics in 1890, 1918 and 2020 per district, age groups and sex
* Comparing of spatial pattern between the pandemics
* Investigate the determinants of spread in the context of different co-factors ( Urbanization, GIP per capita, etc-)

# Data

* Collected and digitalized from Kaspar Staub's team
* Russian flu: 1879 - 1895
* Spanish fl:  1908 - 1925
* Covid19 : 2020


<!-- ## Age -->

<!-- * Age groups aggregated so that there are the same in all years  (for death and population data) -->
<!-- * 1879 - 1885 only larger age groups and not separated by sex -->
<!-- * But total by sex available -->

<!-- ```{r} -->
<!-- load(paste0("../data/data_total.RData"))  -->
<!-- dat.age <- data_total %>% -->
<!--   mutate(Year = as.character(Year), -->
<!--     Year = as.numeric(Year))%>% -->
<!--   arrange(Year) -->

<!-- dat.tab.age <- as.data.frame.matrix(table(data_total$Year, data_total$age_group)) %>% -->
<!--   mutate(Year = row.names(.)) %>% -->
<!--   mutate_if(is.integer, ~ if_else(.>0,"1", "0")) %>% -->
<!--   mutate(Year = as.numeric(Year)) %>% -->
<!--   arrange(Year) %>% -->
<!--   select(Year, `0_4`, `5_14`:`>60`, `0_19`:`60_69`, `>70`) -->

<!-- dat.tab.age %>% -->
<!--   kbl(row.names = F) %>% -->
<!--   kable_material(c("striped", "hover"),full_width = F,position = "left") -->
<!-- ``` -->

## Population

* Modern data population for all districts and all age groups and sex available
* Census 1888 and 1910 population data for all districts and age groups and sex, but 1900 and 1920 are not collect ->  might a problem
* Census 1880, 1888, 1900, 1910, 1920  census data for all districts
<br />
<br />
Estimation:
* Interpolation for total and each districts (census 1880, 1888, 1900, 1910, 1920)
* Calculation of age distribution for 1888 and 1910
* Take age distribution of 1888 to interpolate population between 1880 to 1900 and age distribution from 1910 to interpolate population between 1900 and 1920
* Maybe a student from Kaspar will also collect detailed census data from 1900 and 1920, would be a bit more precise then

## Maps

* All districts are harmonised so that 1890, 1918 and 2020 have the same districts.
* Many districts from 1879 - 1920 have been combined so that they are the same as 2014-2020.
* Schauffhausen is only one district, as death data is only available for Schaffhausen as a whole.
* In Solothurn, the districts are merged as in 1876 - 1920.
* New shapefiles created via QGIS to have one map for all years (to make them comparable).

# Preliminary Methods
* Estimation of expected mortality using Poisson GLM for total, sex and age groups
* Only yearly data available, therefor no seasonal effects etc can be taken into account
* Excess mortality is based on the trend in the previous 4 years (sind for 1890 only 4 years available)
* Pandemic years 1890, 1918 and 2020 are excluded to estimate expected values
* Bootstrapping to address the uncertainty in observed death counts and to provide a prediction interval (PI) for the predicted mortality(resampled N = 1000)
* Excess mortality is shown relatively in percentage (excess mortality = (pandemic year -baseline mortality)/baseline mortality
* To compare the districts the percentages are normalised, meaning for each year the quantiles are estimated, to see for example if same district have high excess mortality between the pandemics
* To find pattern and clusters: Moran’s I statistics ( LISA: Local Indicators of Spatial Association) were user mapping statistically significant local clusters.


# Preliminary Results

## Total

### Relative yearly numbers of excess deaths
```{r, echo=FALSE,message=FALSE,fig.height = 30,  fig.width = 10}
function_year()
```

### Maps
```{r, echo=FALSE,message=FALSE,fig.height = 12,  fig.width = 10}
function_maps("excess_per_quant2")
```

### LISA (Local Indicators of Spatial Association)
```{r, echo=FALSE,message=FALSE,fig.height = 12,  fig.width = 10}
cowplot::plot_grid(function_lisa(1890),function_lisa(1918),function_lisa(2020),
                   nrow =2 ,ncol = 2)
```

## Sex

<!-- ### Women -Relative yearly numbers of excess deaths -->
<!-- ```{r, echo=FALSE,message=FALSE,fig.height = 30,  fig.width = 10} -->
<!-- function_year_sex(Sex="f") -->
<!-- ``` -->

<!-- ### Men -Relative yearly numbers of excess deaths -->
<!-- ```{r, echo=FALSE,message=FALSE,fig.height = 30,  fig.width = 10} -->
<!-- function_year_sex(Sex="m") -->
<!-- ``` -->

### Maps
```{r, echo=FALSE,message=FALSE,fig.height = 12,  fig.width = 10}
function_maps_sex("excess_per_quant2")
```

### LISA (Local Indicators of Spatial Association)
```{r, echo=FALSE,message=FALSE,fig.height = 12,  fig.width = 10}
cowplot::plot_grid(function_lisa_sex(1890, "f"),function_lisa_sex(1890, "m"),
                   function_lisa_sex(1918, "f"),function_lisa_sex(1918, "m"),
                   function_lisa_sex(2020, "f"),function_lisa_sex(2020, "m"),
                   nrow =3 ,ncol = 2)
```

## Age
* Only two age groups 0-69 and >=70.
* More precise age groups would lead to a lot of zeros in small districts
* Even with two age groups, zeros in some districts

<!-- ### 0-19 - Relative yearly numbers of excess deaths -->
<!-- ```{r, echo=FALSE,message=FALSE,fig.height = 30,  fig.width = 10} -->
<!-- function_year_age(Age="0_19") -->
<!-- ``` -->

<!-- ### 20-49 - Relative yearly numbers of excess deaths -->
<!-- ```{r, echo=FALSE,message=FALSE,fig.height = 30,  fig.width = 10} -->
<!-- function_year_age(Age="20_49") -->
<!-- ``` -->

<!-- ### 50-69 - Relative yearly numbers of excess deaths -->
<!-- ```{r, echo=FALSE,message=FALSE,fig.height = 30,  fig.width = 10} -->
<!-- function_year_age(Age="50_69") -->
<!-- ``` -->

<!-- ### >=70 - Relative yearly numbers of excess deaths -->
<!-- ```{r, echo=FALSE,message=FALSE,fig.height = 30,  fig.width = 10} -->
<!-- function_year_age(Age=">70") -->
<!-- ``` -->

### Maps
```{r, echo=FALSE,message=FALSE,fig.height = 12,  fig.width = 10}
function_maps_age2("excess_perc_year_quant2")
```

### LISA (Local Indicators of Spatial Association)
```{r, echo=FALSE,message=FALSE,fig.height = 12,  fig.width = 10}
cowplot::plot_grid(function_lisa_age(1890, "0_69"),function_lisa_age(1890, ">70"),
                   function_lisa_age(1918, "0_69"),function_lisa_age(1918, ">70"),
                   function_lisa_age(2020, "0_69"),function_lisa_age(2020, ">70"),
                   nrow =3 ,ncol = 2)
```

# Next steps, points to doscuess

1. Bayesian approaches in hierarchical modelling (INLA)
  * Lot of zeros, especially for age groups
  * Bayesian approaches in hierarchical modelling (INLA) to investigate the spatial pattern of excess mortality per district
2. Groups
 * Too many age groups leads to many zeros -> too many zeros are also an issue with INLA
 * Maybe only 0-69 and >70 or 0-40, 41-69, >70
 * Its is not possible to stratify by age and sex -> to many zeros
 * We can estimate excess mortality for age groups and sex, but not by age groups for each sex
2. Further Co-factors (I have to discuss with Kaspar):
 * Urbanization
 * Infant mortality rates as a proxy for health index
 * Public health intervention for each district (canton)
 * GDP per capita as proxy for SES
 * Population density (population/km2)
 * Proportion of children, 5–15 y (as school-age children are thought to drive influenza transmission)
 





